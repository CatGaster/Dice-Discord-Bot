# Содержание
- [Модуль `dice.py`](#документация-к-модулю-dicepy)
- [Модуль 'character.py'](#документация-к-модулю-characterpy)
- [Модуль `clear.py`](#документация-к-модулю-clearpy)
- [Модуль `wise_wizard.py`](#документация-к-модулю-wise_wizardpy)


# Документация к модулю `dice.py`

Модуль `dice.py` предоставляет функциональность для бросков кубиков, включая стандартные типы, кастомные настройки и использование характеристик пользователя для модификаторов. Этот модуль поддерживает как префиксные(!), так и слэш-команды.

## Основная функциональность

### 1. **Бросок стандартных кубиков**
Поддерживаются стандартные кубики: 1d2, 1d4, 1d6, 1d8, 1d12, 1d20. Пользователь может выбрать кубик с помощью кнопок.

### 2. **Кастомные кубики**
Пользователь может задать количество граней и бросков для кастомного кубика. Поддерживаются дополнительные кубики и числовые модификаторы в формате `1d6+2d8-5`.

### 3. **Модификаторы характеристик**
Модуль может учитывать модификаторы характеристик пользователя (например, "Сила" или "Ловкость"). Значение модификатора рассчитывается как `(значение - 10) // 2`.

### 4. **Голосовые уведомления (TTS)**
Пользователь может включать или отключать текстовые уведомления через TTS (Text-to-Speech).

## Основные функции

### `roll_dice(sides, rolls=1)`
- **Описание:** Бросает кубик с заданным количеством граней и возвращает результаты.
- **Параметры:**
  - `sides` (int): Количество граней кубика.
  - `rolls` (int): Количество бросков (по умолчанию 1).
- **Возвращает:** Список с результатами каждого броска.

### `calculate_modifier(stat_value)`
- **Описание:** Рассчитывает модификатор для характеристики.
- **Параметры:**
  - `stat_value` (int): Значение характеристики.
- **Возвращает:** Модификатор (int).

## Команды

### 1. **`/roll_dice` (слэш-команда)**
- **Описание:** Позволяет пользователю выбрать кубик для броска через интерактивные кнопки.
- **Взаимодействие:** Выводит кнопки для стандартных кубиков и кастомного броска.

### 2. **`!roll_dice` или `!rd` (префиксная команда)**
- **Описание:** Аналогичная функциональность для пользователей, предпочитающих текстовые команды.
- **Взаимодействие:** Выводит кнопки для выбора кубика.

## Интерактивные элементы

### Кнопки для стандартных кубиков
- **Кубики:** 1d2, 1d4, 1d6, 1d8, 1d12, 1d20.
- **Действие:** Бросает выбранный кубик и выводит результаты.

### Кнопка для кастомного кубика
- **Действие:** Открывает модальное окно для ввода параметров:
  - Количество граней.
  - Количество бросков.
  - Характеристика для модификатора.
  - Дополнительные кубики,числовые бонусы и модификаторы характеристик.

### Кнопка для управления TTS
- **Действие:** Включает или отключает текстовые уведомления через TTS.

## Логика работы кастомных кубиков
1. Пользователь вводит параметры в модальном окне.
2. Основной бросок рассчитывается через `roll_dice`.
3. Если указана характеристика, модуль получает её значение через функцию `get_user_stats`.
4. Дополнительные кубики и модификаторы анализируются с помощью регулярных выражений.
5. Итоговый результат формируется и выводится пользователю.

## Пример взаимодействия

1. Пользователь вводит команду `/roll_dice`.
2. Бот отображает кнопки для выбора кубиков.
3. Пользователь нажимает на кнопку `1d20`.
4. Бот бросает кубик и отправляет сообщение: `1d20: 15`.

## Зависимости
- **Библиотеки:**
  - `discord`
  - `discord.ext.commands`
  - `discord.ui`
  - `random`
  - `re`
- **Другие модули:**
  - `character.get_user_stats` для получения данных о характеристиках пользователя.

## Ограничения
- Максимальное количество бросков для одного кубика не ограничено, но слишком большие значения могут привести к задержкам.
- Формат дополнительных кубиков должен соответствовать шаблону `NdM+NdM-...` (например, `2d6+1d8-5`).




# Документация к модулю `character.py`

Модуль `character.py` предоставляет функциональность для управления характеристиками персонажей пользователей Discord. Он позволяет просматривать, изменять и сохранять характеристики через интерактивные элементы, такие как кнопки и модальные окна. Поддерживаются как префиксные команды (!), так и слэш-команды.

---

## Основная функциональность

### 1. **Просмотр характеристик**
Пользователь может получить список своих характеристик в удобном формате. Для каждого значения создаётся кнопка, которая позволяет изменить значение характеристики.

### 2. **Изменение характеристик**
Характеристики можно изменить, выбрав соответствующую кнопку и введя новое значение в модальном окне. 

### 3. **Хранение данных**
Данные пользователей хранятся в базе данных SQLite. Для каждого пользователя создаётся запись с характеристиками:
- Сила
- Ловкость
- Стойкость
- Мудрость
- Харизма
- Интеллект
- Уровень

---

## Основные функции

### `init_db()`
- **Описание:** Инициализирует базу данных SQLite, создавая таблицу `user_stats`, если она не существует.
- **Таблица содержит:**
  - `user_id` (str): ID пользователя.
  - `strength`, `dexterity`, `constitution`, `wisdom`, `charisma`, `intelligence`, `level`  (int): Значения характеристик.

### `get_user_stats(user_id)`
- **Описание:** Возвращает текущие характеристики пользователя в виде словаря.
- **Параметры:**
  - `user_id` (str): ID пользователя.
- **Возвращает:** Словарь с характеристиками. Если пользователь отсутствует в базе, все значения будут равны `0`.

### `set_user_stat(user_id, stat_name, value)`
- **Описание:** Устанавливает новое значение для указанной характеристики пользователя.
- **Параметры:**
  - `user_id` (str): ID пользователя.
  - `stat_name` (str): Название характеристики (например, "Сила").
  - `value` (int): Новое значение характеристики.

### `send_character_list(ctx)`
- **Описание:** Отправляет пользователю список кнопок для изменения характеристик.
- **Параметры:**
  - `ctx`: Контекст команды (для префиксных команд) или взаимодействие (для слэш-команд).

---

## Команды

### 1. **`!character_list` или `!cl` (префиксная команда)**
- **Описание:** Позволяет просмотреть и изменить характеристики персонажа.
- **Взаимодействие:** Отправляет сообщение с кнопками для изменения характеристик.

### 2. **`/character_list` (слэш-команда)**
- **Описание:** Аналогично префиксной команде, но используется через интерфейс слэш-команд.
- **Взаимодействие:** Создаёт список кнопок для изменения характеристик.

---

## Интерактивные элементы

### Кнопки для изменения характеристик
- **Действие:** Позволяют изменить значение характеристики через модальное окно. 
- **Алгоритм работы:**
  1. Пользователь нажимает на кнопку с названием характеристики.
  2. Бот открывает модальное окно с полем ввода.
  3. Пользователь вводит новое значение.
  4. Значение сохраняется в базе данных.

---

## Пример взаимодействия

1. Пользователь вводит команду `!character_list` или `/character_list`.
2. Бот отправляет сообщение с кнопками: "Сила", "Ловкость", "Стойкость", "Мудрость", "Харизма", "Интеллект".
3. Пользователь нажимает на кнопку, например, "Сила".
4. Бот открывает модальное окно с запросом нового значения.
5. Пользователь вводит значение, например, `12`.
6. Бот сохраняет значение в базе данных и подтверждает изменение.

---

## Зависимости

- **Библиотеки:**
  - `discord`
  - `discord.ext.commands`
  - `discord.ui`
  - `sqlite3`
- **Связанные модули:**
  - `dice.py` — для работы с кубиками, использующими характеристики.

---

## Ограничения

1. Только зарегистрированные пользователи могут изменять свои характеристики.
2. Названия характеристик чувствительны к регистру в коде, но обрабатываются в нижнем регистре при взаимодействии.
3. База данных SQLite ограничена одной таблицей `user_stats`.

---

## Расширяемость

Для добавления новых характеристик необходимо:
1. Обновить таблицу `user_stats` в базе данных.
2. Добавить новую характеристику в словарь `stat_columns` в функции `set_user_stat`.
3. Добавить кнопку и логику обработки в функцию `send_character_list`.





# Документация к модулю `clear.py`

Модуль `clear.py` предоставляет функциональность для удаления сообщений, отправленных ботом, как с помощью префиксных (!), так и слэш-команд. Это полезно для очистки чата от спама или устаревших сообщений бота.

---

## Основная функциональность

### 1. **Удаление сообщений бота**
Команда позволяет удалить определённое количество сообщений, отправленных ботом, из текстового канала. 

### 2. **Лимиты удаления**
- Максимальное количество проверяемых сообщений за раз: **100**.
- Максимальное количество удаляемых сообщений за раз: **20**.

---

## Основные функции

### `setup_clear_commands(bot)`
- **Описание:** Регистрирует команды для удаления сообщений.
- **Параметры:**
  - `bot` (commands.Bot): Экземпляр бота.
- **Регистрируемые команды:**
  - Слэш-команда `/clear_bot_messages`.
  - Префиксная команда `!clear_bot_messages` (с алиасом `!clear_bot`).

### `clear_bot_messages(channel, limit, send_message)`
- **Описание:** Удаляет указанное количество сообщений, отправленных ботом, из заданного текстового канала.
- **Параметры:**
  - `channel` (discord.TextChannel): Текстовый канал для удаления сообщений.
  - `limit` (int): Количество сообщений для удаления.
  - `send_message` (Callable): Функция для отправки уведомлений пользователю.
- **Обработка ошибок:**
  - Если бот не имеет прав на удаление сообщений, отправляется уведомление.
  - Если превышен лимит запросов Discord API, отправляется соответствующее сообщение.

---

## Команды

### 1. **`/clear_bot_messages` (слэш-команда)**
- **Описание:** Удаляет сообщения, отправленные ботом.
- **Параметры:**
  - `limit` (int): Количество сообщений для удаления (по умолчанию 20, максимум 20).
- **Пример использования:**
  - `/clear_bot_messages limit:10` — удаляет последние 10 сообщений бота.

### 2. **`!clear_bot_messages` или `!clear_bot` (префиксная команда)**
- **Описание:** Аналогично слэш-команде, но используется через префикс.
- **Параметры:**
  - `limit` (int): Количество сообщений для удаления (по умолчанию 10, максимум 20).
- **Пример использования:**
  - `!clear_bot_messages 15` — удаляет последние 15 сообщений бота.

---

## Пример взаимодействия

1. Пользователь вводит команду `/clear_bot_messages limit:10`.
2. Бот проверяет наличие сообщений бота в канале.
3. Если в канале менее 10 сообщений бота, бот уведомляет об этом.
4. Если сообщений достаточно, бот удаляет их и отправляет сообщение: `Удалено 10 сообщений бота.`

---

## Ограничения

1. **Права доступа:** Бот должен иметь разрешение `Manage Messages` для удаления сообщений.
2. **Лимит Discord API:** Удаление слишком большого количества сообщений может привести к ошибке "429 Too Many Requests".
3. **Контекст:** Команда работает только в текстовых каналах.

---

## Расширяемость

1. **Изменение лимитов:**
   - Параметр `MAX_LIMIT` регулирует количество проверяемых сообщений.
   - Параметр `DELETE_LIMIT` ограничивает количество удаляемых сообщений за раз.
2. **Обработка других типов сообщений:**
   - Фильтрацию можно расширить для удаления сообщений по другим критериям (например, по ключевым словам).

---

## Зависимости

- **Библиотеки:**
  - `discord`
  - `discord.ext.commands`
  - `asyncio`

---

## Возможные ошибки и их обработка

1. **Недостаток прав:** Если бот не имеет права на удаление сообщений, отправляется уведомление пользователю.
2. **Превышение лимита API:** При превышении лимита запросов Discord API (код ошибки 429) выводится сообщение о необходимости повторить попытку позже.
3. **Недостаточно сообщений:** Если в канале недостаточно сообщений бота, выводится соответствующее уведомление.

---


# Документация к модулю `wise_wizard.py`

Модуль wise_wizard.py предоставляет функциональность для общения с древним магом Бальтазаром, который отвечает на вопросы в стиле Dungeons & Dragons, используя архаичный язык, пословицы и метафоры с помощью OpenAI

## Основная функциональность

### 1. **Задавайте вопросы древнему магу Бальтозару Мудрому**

- **Обращение к мудрому магу Бальтазару**:
Модуль отправляет вопросы к API OpenRouter с заранее заданным системным промптом, который задаёт стиль ответов от лица древнего мага Бальтазара. 

### 1. **`/wise_wizard` (слэш-команда)**
- **Описание:** Позволяет обратиться к боту
- **Пример использования:**
  - `/wise_wizard Расскажи про короткий меч` — А, короткий меч! Оружие, достойное рук ловких и хитрых воинов. Весом не обременяет, в бою проворен, как змея в траве. Урон его — 1d6, и если рука, что держит его, искусна, то к урону прибавляется модификатор Ловкости. Ведь не сила, а умение решает исход схватки.

### 2. **`wise_wizard` или `!ask` (префиксная команда)**
- **Описание:** Аналогично слэш-команде, но используется через префикс.


## Зависимости

### Переменные окружения:
- `OPENROUTER_API_KEY – ключ для доступа к API OpenRouter.`

- **Библиотеки:**
- `discord`
- `discord.ext.commands`
- `asyncio`
- `dotenv`
- `os`
- `openai`
